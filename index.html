<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>ç¾åœ°ARé…ç½®</title>

<script type="module"
  src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
</script>

<style>
  body {
    margin: 0;
    font-family: sans-serif;
    background: #000;
  }
  #ui {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    text-align: center;
  }
  button {
    font-size: 16px;
    padding: 10px 20px;
  }
  #msg {
    color: white;
    margin-bottom: 8px;
  }
</style>
</head>

<body>

<model-viewer
  id="viewer"
  src="model.glb"
  ar
  ar-modes="webxr quick-look"
  camera-controls
  tone-mapping="neutral"
  shadow-intensity="1"
  style="width:100vw;height:100vh;">
</model-viewer>

<div id="ui">
  <div id="msg">ARé–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
  <button id="startAR">ARé–‹å§‹</button>
</div>

<script>
const viewer = document.getElementById("viewer");
const msg = document.getElementById("msg");
const startBtn = document.getElementById("startAR");

let points = [];
let step = 0;

// ARé–‹å§‹
startBtn.onclick = async () => {
  await viewer.activateAR();
  msg.textContent = "åŸºæº–ç‚¹Aã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„";
  startBtn.style.display = "none";
};

// ç”»é¢ã‚¿ãƒƒãƒ—ï¼ˆãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼‰
viewer.addEventListener("click", async (e) => {
  if (!viewer.arStatus === "session-started") return;
  if (points.length >= 2) return;

  const hit = await viewer.positionAndNormalFromPoint(
    e.clientX,
    e.clientY
  );

  if (!hit) return;

  points.push(hit.position);
  placeMarker(hit.position);

  if (points.length === 1) {
    msg.textContent = "åŸºæº–ç‚¹Bã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„";
  }

  if (points.length === 2) {
    alignModel(points[0], points[1]);
    msg.textContent = "é…ç½®å®Œäº†";
  }
});

// ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
function placeMarker(pos) {
  const marker = document.createElement("model-viewer");
  marker.src =
    "data:model/gltf-binary;base64,AAAAGGZ0eXBnb..." // ç°¡æ˜“çƒä½“ï¼ˆçœç•¥OKï¼‰
  marker.style.display = "none";

  viewer.scene.add({
    type: "sphere",
    radius: 0.05,
    position: pos,
    material: { color: "red" }
  });
}

// ãƒ¢ãƒ‡ãƒ«ã‚’Aâ†’Bæ–¹å‘ã¸å›è»¢
function alignModel(A, B) {
  const dx = B.x - A.x;
  const dz = B.z - A.z;
  const angle = Math.atan2(dx, dz);

  viewer.orientation = `0 ${angle * 180 / Math.PI} 0`;
  viewer.position = `${A.x} ${A.y} ${A.z}`;
}

// ğŸ§­ åŒ—å‘ãçŸ¢å°
window.addEventListener("deviceorientationabsolute", (e) => {
  if (!viewer.scene) return;
  const heading = e.alpha || 0;
  viewer.scene.rotation.y = -heading * Math.PI / 180;
});
</script>

</body>
</html>
